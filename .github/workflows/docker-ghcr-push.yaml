name: Docker GHCR Push

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag for Docker images (e.g. 1.0.3-patch)."
        required: false
        type: string

permissions:
  packages: write
  contents: read
  id-token: write

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.determine-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Determine version tag
        id: determine-version
        run: |
          # Use manual input if provided
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "Using manually specified version: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else                                                                                                                                                         
            VERSION="${{ github.sha }}"
            echo "Version unchanged, falling back to commit SHA: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

  docker-ghcr-push-sidecar-indexer:
    needs: get-version
    uses: phylaxsystems/actions/.github/workflows/release-docker-ghcr-nodejs.yaml@main
    with:
      app-name: sidecar-indexer
      node-version: "22.14"
      dockerfile-path: Dockerfile
      version-tag: ${{ needs.get-version.outputs.version }}